<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ClearentOnReceiverListener.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">clearent-idtech-android</a> &gt; <a href="index.source.html" class="el_package">com.clearent.idtech.android</a> &gt; <span class="el_source">ClearentOnReceiverListener.java</span></div><h1>ClearentOnReceiverListener.java</h1><pre class="source lang-java linenums">package com.clearent.idtech.android;

import com.clearent.idtech.android.config.DeviceConfigurator;
import com.clearent.idtech.android.config.DeviceConfiguratorImpl;
import com.clearent.idtech.android.domain.CommunicationRequest;
import com.clearent.idtech.android.domain.EntryMode;
import com.clearent.idtech.android.domain.CardReadResponseCode;
import com.clearent.idtech.android.family.IDTDevice;
import com.clearent.idtech.android.token.domain.EmvCardDataImpl;
import com.clearent.idtech.android.token.domain.SwipeCardDataImpl;
import com.clearent.idtech.android.token.services.CardTokenizer;
import com.clearent.idtech.android.token.services.CardTokenizerImpl;
import com.idtechproducts.device.*;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import static com.idtechproducts.device.ReaderInfo.EVENT_MSR_Types.EVENT_MSR_CARD_DATA;

public class ClearentOnReceiverListener implements OnReceiverListener {

    public static final String EMV_TAG_ENTRY_MODE = &quot;9F39&quot;;
    private IDTDevice idtDevice;
    private PublicOnReceiverListener publicOnReceiverListener;
<span class="fc" id="L26">    private boolean previousDipDidNotMatchOnApp = false;</span>
<span class="fc" id="L27">    private int numberOfUseChipReaderNotifications = 0;</span>
    private Logger logger;

<span class="fc" id="L30">    public ClearentOnReceiverListener(IDTDevice idtDevice, PublicOnReceiverListener publicOnReceiverListener, Logger logger) {</span>
<span class="fc" id="L31">        this.idtDevice = idtDevice;</span>
<span class="fc" id="L32">        this.publicOnReceiverListener = publicOnReceiverListener;</span>
<span class="fc" id="L33">        this.logger = logger;</span>
<span class="fc" id="L34">    }</span>

    @Override
    public void swipeMSRData(IDTMSRData idtmsrData) {

<span class="nc bnc" id="L39" title="All 4 branches missed.">        if (idtmsrData != null &amp;&amp; idtmsrData.isCTLS) {</span>
<span class="nc" id="L40">            handleTransactionResponse(CardReadResponseCode.CONTACTLESS_NOT_SUPPORTED);</span>
<span class="nc" id="L41">            return;</span>
        }

<span class="nc bnc" id="L44" title="All 10 branches missed.">        if (idtmsrData == null || idtmsrData.result != ErrorCode.SUCCESS || idtmsrData.event != EVENT_MSR_CARD_DATA || (idtmsrData.track2 == null &amp;&amp; idtmsrData.encTrack2 == null)) {</span>
<span class="nc" id="L45">            handleTransactionResponse(CardReadResponseCode.BAD_SWIPE);</span>
<span class="nc" id="L46">            return;</span>
        }

        //Make sure they are notified at least once they are swiping a chip card. We don't want to stop them from running a transaction.
<span class="nc bnc" id="L50" title="All 8 branches missed.">        if (idtmsrData != null &amp;&amp; idtmsrData.iccPresent &amp;&amp; !isPreviousDipDidNotMatchOnApp() &amp;&amp; numberOfUseChipReaderNotifications == 0) {</span>
<span class="nc" id="L51">            idtDevice.msr_cancelMSRSwipe();</span>
<span class="nc" id="L52">            handleTransactionResponse(CardReadResponseCode.USE_CHIP_READER);</span>
<span class="nc" id="L53">            return;</span>
        }

<span class="nc" id="L56">        CardTokenizer cardTokenizer = new CardTokenizerImpl(idtDevice, new Logger());</span>

<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (isPreviousDipDidNotMatchOnApp()) {</span>
<span class="nc" id="L59">            setPreviousDipDidNotMatchOnApp(false);</span>
<span class="nc" id="L60">            cardTokenizer.createTransactionTokenForFallback(new SwipeCardDataImpl(idtmsrData));</span>
        } else {
<span class="nc" id="L62">            cardTokenizer.createTransactionToken(new SwipeCardDataImpl(idtmsrData));</span>
        }
<span class="nc" id="L64">    }</span>

    @Override
    public void lcdDisplay(int i, String[] strings, int i1) {
<span class="nc" id="L68">        publicOnReceiverListener.lcdDisplay(i, monitorMessages(strings), i1);</span>
<span class="nc" id="L69">    }</span>

    @Override
    public void lcdDisplay(int i, String[] strings, int i1, byte[] bytes, byte b) {
<span class="nc" id="L73">        publicOnReceiverListener.lcdDisplay(i, monitorMessages(strings), i1, bytes, b);</span>
<span class="nc" id="L74">    }</span>

    String[] monitorMessages(String[] messages) {
<span class="fc bfc" id="L77" title="All 4 branches covered.">        if (messages == null || messages.length == 0) {</span>
<span class="fc" id="L78">            return new String[]{};</span>
        }
<span class="fc" id="L80">        List&lt;String&gt; messageList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        for (String message : messages) {</span>
<span class="pc bpc" id="L82" title="2 of 4 branches missed.">            if (message != null &amp;&amp; &quot;USE MAGSTRIPE&quot;.equalsIgnoreCase(message)) {</span>
<span class="nc" id="L83">                publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.USE_MAGSTRIPE);</span>
<span class="nc" id="L84">                messageList.add(message);</span>
<span class="pc bpc" id="L85" title="2 of 4 branches missed.">            } else if (message != null &amp;&amp; &quot;USE CHIP READER&quot;.equalsIgnoreCase(message)) {</span>
<span class="nc" id="L86">                ++numberOfUseChipReaderNotifications;</span>
<span class="nc" id="L87">                publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.USE_CHIP_READER);</span>
<span class="nc" id="L88">                messageList.add(message);</span>
<span class="pc bpc" id="L89" title="1 of 4 branches missed.">            } else if (message != null &amp;&amp; &quot;TERMINATE&quot;.equalsIgnoreCase(message)) {</span>
<span class="fc" id="L90">                publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.TERMINATE);</span>
<span class="fc" id="L91">                messageList.add(message);</span>
<span class="pc bpc" id="L92" title="1 of 4 branches missed.">            } else if (message != null &amp;&amp; &quot;DECLINED&quot;.equalsIgnoreCase(message)) {</span>
<span class="fc" id="L93">                logger.d(&quot;CLEARENT&quot;, &quot;This is not really a decline. Clearent is creating a transaction token for later use.&quot;);</span>
<span class="pc bpc" id="L94" title="1 of 4 branches missed.">            } else if (message != null &amp;&amp; &quot;APPROVED&quot;.equalsIgnoreCase(message)) {</span>
<span class="fc" id="L95">                logger.d(&quot;CLEARENT&quot;, &quot;This is not really an approval. Clearent is creating a transaction token for later use.&quot;);</span>
            } else {
<span class="fc" id="L97">                messageList.add(message);</span>
            }
        }
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (messageList.size() == 0) {</span>
<span class="fc" id="L101">            return new String[]{};</span>
        }

<span class="fc" id="L104">        String[] convertedMessages = new String[messageList.size()];</span>
<span class="fc" id="L105">        convertedMessages = messageList.toArray(convertedMessages);</span>

<span class="fc" id="L107">        return convertedMessages;</span>
    }

    private void handleTransactionResponse(CardReadResponseCode cardReadResponseCode) {
<span class="nc" id="L111">        publicOnReceiverListener.handleCardReadResponse(cardReadResponseCode);</span>
<span class="nc" id="L112">    }</span>

    @Override
    public void emvTransactionData(IDTEMVData idtemvData) {
<span class="nc" id="L116">        IDTEMVData card = idtemvData;</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (idtemvData == null) {</span>
<span class="nc" id="L119">            return;</span>
        }

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (idtemvData.cardType == 1) {</span>
<span class="nc" id="L123">            cancelEmvTransaction();</span>
<span class="nc" id="L124">            publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.CONTACTLESS_NOT_SUPPORTED);</span>
<span class="nc" id="L125">            return;</span>
        }

<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (idtemvData.result == IDTEMVData.TIME_OUT) {</span>
<span class="nc" id="L129">            cancelEmvTransaction();</span>
<span class="nc" id="L130">            publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.TIMEOUT);</span>
<span class="nc" id="L131">            return;</span>
        }

<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (idtemvData.result == IDTEMVData.DECLINED_OFFLINE) {</span>
<span class="nc" id="L135">            publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.DECLINED_OFFLINE);</span>
<span class="nc" id="L136">            return;</span>
        }

<span class="nc" id="L139">        logger.d(&quot;CLEARENT&quot;, &quot;emvTransactionData result &quot; + Common.emvErrorCodes(idtemvData.result));</span>

        //this is the non technical fallback swipe
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (idtemvData.result == IDTEMVData.APP_NO_MATCHING) {</span>

<span class="nc" id="L144">            logger.d(&quot;CLEARENT&quot;, &quot;App no match&quot;);</span>
<span class="nc" id="L145">            EntryMode entryMode = getEntryMode(idtemvData);</span>
<span class="nc" id="L146">            logger.d(&quot;CLEARENT&quot;, &quot;Entry Mode is &quot; + entryMode.name());</span>

<span class="nc" id="L148">            boolean isOkayToStartSwipe = false;</span>
<span class="nc" id="L149">            int numberOfTimesWaitingForCardToUnseat = 0;</span>

<span class="nc bnc" id="L151" title="All 4 branches missed.">            while (!isOkayToStartSwipe &amp;&amp; numberOfTimesWaitingForCardToUnseat &lt; 10) {</span>
                try {
<span class="nc" id="L153">                    Thread.sleep(1000);</span>
<span class="nc" id="L154">                } catch (InterruptedException e) {</span>
<span class="nc" id="L155">                    logger.d(&quot;CLEARENT&quot;, &quot;Sleep failed in app no matching logic&quot;);</span>
<span class="nc" id="L156">                }</span>
<span class="nc" id="L157">                ICCReaderStatusStruct iccStatus = new ICCReaderStatusStruct();</span>
<span class="nc" id="L158">                int ret = idtDevice.icc_getICCReaderStatus(iccStatus);</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">                if (ret == 0 &amp;&amp; !iccStatus.cardSeated) {</span>
<span class="nc" id="L160">                    isOkayToStartSwipe = true;</span>
<span class="nc" id="L161">                    setPreviousDipDidNotMatchOnApp(true);</span>
<span class="nc" id="L162">                    logger.d(&quot;CLEARENT&quot;, &quot;Card is unseated. Start swipe&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                } else if (numberOfTimesWaitingForCardToUnseat == 0) {</span>
<span class="nc" id="L164">                    publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.REMOVE_CARD_AND_TRY_SWIPE);</span>
                }
<span class="nc" id="L166">                ++numberOfTimesWaitingForCardToUnseat;</span>
<span class="nc" id="L167">            }</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (isOkayToStartSwipe) {</span>
<span class="nc" id="L170">                publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.SWIPE_CARD);</span>
<span class="nc" id="L171">                idtDevice.msr_startMSRSwipe(30);</span>
            } else {
<span class="nc" id="L173">                publicOnReceiverListener.handleCardReadResponse(CardReadResponseCode.FALLBACK_TO_SWIPE_FAILED);</span>
            }

<span class="nc" id="L176">            return;</span>
        }

        //The mobile-jwt call should succeed or fail. We call the IDTech complete method every time.
<span class="nc bnc" id="L180" title="All 4 branches missed.">        if (idtemvData.result == IDTEMVData.APPROVED || idtemvData.result == IDTEMVData.APPROVED_OFFLINE) {</span>
<span class="nc" id="L181">            return;</span>
        }

        //We aren't starting an authorization so this result code should never be set. But return just in case.
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (idtemvData.result == IDTEMVData.START_TRANS_SUCCESS) {</span>
<span class="nc" id="L186">            return;</span>
        }

<span class="nc" id="L189">        EntryMode entryMode = getEntryMode(idtemvData);</span>
<span class="nc" id="L190">        logger.d(&quot;CLEARENT&quot;, &quot;Entry Mode is &quot; + entryMode.name());</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (EntryMode.INVALID.equals(entryMode)) {</span>
<span class="nc" id="L192">            logger.d(&quot;CLEARENT&quot;, &quot;No entry mode found. Skip processing.&quot;);</span>
<span class="nc" id="L193">            return;</span>
        }

<span class="nc bnc" id="L196" title="All 4 branches missed.">        if (idtemvData.msr_cardData != null &amp;&amp; idtemvData.result == IDTEMVData.MSR_SUCCESS) {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if (entryMode == EntryMode.FALLBACK_SWIPE) {</span>
<span class="nc" id="L198">                logger.d(&quot;CLEARENT&quot;, &quot;Trying fallback swipe...&quot;);</span>
<span class="nc" id="L199">                CardTokenizer cardTokenizer = new CardTokenizerImpl(idtDevice, new Logger());</span>
<span class="nc" id="L200">                cardTokenizer.createTransactionTokenForFallback(new SwipeCardDataImpl(idtemvData.msr_cardData));</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            } else if (entryMode == EntryMode.SWIPE) {</span>
<span class="nc" id="L202">                logger.d(&quot;CLEARENT&quot;, &quot;Trying swipe from emv method...&quot;);</span>
<span class="nc" id="L203">                swipeMSRData(idtemvData.msr_cardData);</span>
            }
<span class="nc bnc" id="L205" title="All 2 branches missed.">        } else if (idtemvData.result == IDTEMVData.GO_ONLINE) {</span>
<span class="nc" id="L206">            logger.d(&quot;CLEARENT&quot;, &quot;Trying to go online...&quot;);</span>
<span class="nc" id="L207">            CardTokenizer cardTokenizer = new CardTokenizerImpl(idtDevice, new Logger());</span>
<span class="nc" id="L208">            cardTokenizer.createTransactionToken(new EmvCardDataImpl(idtemvData));</span>
        }
<span class="nc" id="L210">    }</span>

    private void cancelEmvTransaction() {
<span class="nc" id="L213">        ResDataStruct resData = new ResDataStruct();</span>
<span class="nc" id="L214">        idtDevice.emv_cancelTransaction(resData);</span>
<span class="nc" id="L215">    }</span>

    private EntryMode getEntryMode(IDTEMVData idtemvData) {
<span class="nc" id="L218">        Map&lt;String, byte[]&gt; tags = null;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (idtemvData.unencryptedTags != null) {</span>
<span class="nc" id="L220">            tags = idtemvData.unencryptedTags;</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        } else if (idtemvData.encryptedTags != null) {</span>
<span class="nc" id="L222">            tags = idtemvData.encryptedTags;</span>
        }
<span class="nc" id="L224">        byte[] entryModeBytes = tags.get(EMV_TAG_ENTRY_MODE);</span>
<span class="nc" id="L225">        String hexStringFromBytes = Common.getHexStringFromBytes(entryModeBytes);</span>
<span class="nc" id="L226">        int entryMode = Integer.decode(hexStringFromBytes);</span>
<span class="nc" id="L227">        return EntryMode.valueOfByInt(entryMode);</span>
    }

    @Override
    public void deviceConnected() {
<span class="nc" id="L232">        publicOnReceiverListener.deviceConnected();</span>
<span class="nc" id="L233">        String[] message = {&quot;Device connected. Waiting for configuration to complete...\n&quot;};</span>
<span class="nc" id="L234">        publicOnReceiverListener.lcdDisplay(0, message, 0);</span>
<span class="nc" id="L235">        retrieveDeviceMetadata();</span>
<span class="nc" id="L236">        configure();</span>
<span class="nc" id="L237">    }</span>

    private void retrieveDeviceMetadata() {
        //Grab this information only after connecting to avoid any 'busy' signals with the reader.
<span class="nc" id="L241">        String previousDeviceSerialNumber = idtDevice.getDeviceSerialNumber();</span>
<span class="nc" id="L242">        idtDevice.setDeviceSerialNumber();</span>
<span class="nc" id="L243">        idtDevice.setFirmwareVersion();</span>
<span class="nc" id="L244">        idtDevice.setKernelVersion();</span>

<span class="nc bnc" id="L246" title="All 4 branches missed.">        if (previousDeviceSerialNumber != null &amp;&amp; !previousDeviceSerialNumber.equals(idtDevice.getDeviceSerialNumber())) {</span>
<span class="nc" id="L247">            idtDevice.setReaderConfigured(false);</span>
        }
<span class="nc" id="L249">    }</span>

    private void configure() {
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!idtDevice.isReaderConfigured()) {</span>
<span class="nc" id="L253">            DeviceConfigurator deviceConfigurator = new DeviceConfiguratorImpl(idtDevice, logger);</span>
<span class="nc" id="L254">            deviceConfigurator.configure(createCommunicationRequest());</span>
<span class="nc" id="L255">        } else {</span>
<span class="nc" id="L256">            idtDevice.setReaderConfigured(true);</span>
        }
<span class="nc" id="L258">    }</span>

    private CommunicationRequest createCommunicationRequest() {
<span class="nc" id="L261">        String kernelVersion = idtDevice.getKernelVersion();</span>
<span class="nc" id="L262">        String deviceSerialNumber = idtDevice.getDeviceSerialNumber();</span>
<span class="nc" id="L263">        return new CommunicationRequest(idtDevice.getPaymentsBaseUrl(), idtDevice.getPaymentsPublicKey(), deviceSerialNumber, kernelVersion);</span>
    }

    @Override
    public void deviceDisconnected() {
<span class="nc" id="L268">        publicOnReceiverListener.deviceDisconnected();</span>
<span class="nc" id="L269">    }</span>

    @Override
    public void timeout(int i) {
<span class="nc" id="L273">        publicOnReceiverListener.timeout(i);</span>
<span class="nc" id="L274">    }</span>

    @Override
    public void autoConfigCompleted(StructConfigParameters structConfigParameters) {
<span class="nc" id="L278">    }</span>

    @Override
    public void autoConfigProgress(int i) {
<span class="nc" id="L282">    }</span>

    @Override
    public void msgRKICompleted(String s) {
<span class="nc" id="L286">    }</span>

    @Override
    public void ICCNotifyInfo(byte[] bytes, String s) {
<span class="nc" id="L290">        publicOnReceiverListener.ICCNotifyInfo(bytes, s);</span>
<span class="nc" id="L291">    }</span>

    @Override
    public void msgBatteryLow() {
<span class="nc" id="L295">        publicOnReceiverListener.msgBatteryLow();</span>
<span class="nc" id="L296">    }</span>

    @Override
    public void LoadXMLConfigFailureInfo(int i, String s) {
<span class="nc" id="L300">        publicOnReceiverListener.LoadXMLConfigFailureInfo(i, s);</span>
<span class="nc" id="L301">    }</span>

    @Override
    public void msgToConnectDevice() {
<span class="nc" id="L305">        publicOnReceiverListener.msgToConnectDevice();</span>
<span class="nc" id="L306">    }</span>

    @Override
    public void msgAudioVolumeAjustFailed() {
<span class="nc" id="L310">        publicOnReceiverListener.msgAudioVolumeAdjustFailed();</span>
<span class="nc" id="L311">    }</span>

    @Override
    public void dataInOutMonitor(byte[] bytes, boolean b) {
<span class="nc" id="L315">        publicOnReceiverListener.dataInOutMonitor(bytes, b);</span>
<span class="nc" id="L316">    }</span>

    /**
     * Call this method to reset state between transactions.
     */
    public void reset() {
<span class="nc" id="L322">        previousDipDidNotMatchOnApp = false;</span>
<span class="nc" id="L323">        numberOfUseChipReaderNotifications = 0;</span>
<span class="nc" id="L324">    }</span>

    public boolean isPreviousDipDidNotMatchOnApp() {
<span class="nc" id="L327">        return previousDipDidNotMatchOnApp;</span>
    }

    public void setPreviousDipDidNotMatchOnApp(boolean previousDipDidNotMatchOnApp) {
<span class="nc" id="L331">        this.previousDipDidNotMatchOnApp = previousDipDidNotMatchOnApp;</span>
<span class="nc" id="L332">    }</span>

    public int getNumberOfUseChipReaderNotifications() {
<span class="nc" id="L335">        return numberOfUseChipReaderNotifications;</span>
    }

    public void setNumberOfUseChipReaderNotifications(int numberOfUseChipReaderNotifications) {
<span class="nc" id="L339">        this.numberOfUseChipReaderNotifications = numberOfUseChipReaderNotifications;</span>
<span class="nc" id="L340">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>